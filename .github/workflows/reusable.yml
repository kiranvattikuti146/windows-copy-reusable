name: PowerShell Task

on:
  workflow_call:
    inputs:
      Machines:
        required: true
        type: string
      UserName:
        required: true
        type: string
      UserPassword:
        required: true
        type: string
      ScriptType:
        required: true
        type: string
      ScriptPath:
        required: false
        type: string
      InlineScript:
        required: false
        type: string
      ScriptArguments:
        required: false
        type: string
      SessionVariables:
        required: false
        type: string

jobs:
  execute-powershell:
    runs-on: self-hosted
    steps:
      - name: Execute PowerShell Script
        run: |
          try {
              # Assign inputs to variables
              $machines = " 10.0.0.5 "
              $username = "kiran"
              $password = "Extender#123"
              $scriptType = "${{ inputs.ScriptType }}"
              $scriptPath = "${{ inputs.ScriptPath }}"
              $inlineScript = "${{ inputs.InlineScript }}"
              $scriptArguments = "${{ inputs.ScriptArguments }}"
              $sessionVariables = "${{ inputs.SessionVariables }}"
              $sourcePath = 'C: UsersPublicPublicDocumentsNOTES'
              $targetPath = 'C: userskiranDesktopNOTES'
              $cleanTarget = $false
              $copyFilesInParallel = $true
               
              # Convert password to secure string and create a credential object
              $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
              $credential = New-Object System.Management.Automation.PSCredential ($username, $securePassword)

              # Add the specific IP address to TrustedHosts
              Set-Item -Path WSMan:\localhost\Client\TrustedHosts -Value $machines -Force

              # Test connectivity to the remote machine
              Test-Connection -ComputerName $machines -Count 1 -ErrorAction Stop

              # Execute based on ScriptType
              if ($scriptType -eq 'FilePath') {
                  if (-not $scriptPath) {
                      throw "ScriptPath is required when ScriptType is 'FilePath'."
                  }
                  Invoke-Command -ComputerName $machines -Credential $credential -FilePath $scriptPath -ArgumentList $scriptArguments
              } elseif ($scriptType -eq 'Inline') {
                  if (-not $inlineScript) {
                      throw "InlineScript is required when ScriptType is 'Inline'."
                  }
                  $scriptBlock = [ScriptBlock]::Create($inlineScript)
                  $pw_result = Invoke-Command -ComputerName $machines -Credential $credential -ScriptBlock $scriptBlock -Verbose
                  Write-Output $pw_result
                  Write-Host $pw_result
              } else {
                  throw "Invalid ScriptType provided. Valid values are 'FilePath' or 'Inline'."
              }

              # Additional logic for file copy
              if ($copyFilesInParallel) {
                  Write-Host "Copying files in parallel from $sourcePath to $targetPath"
                  Start-Job -ScriptBlock {
                      Copy-Item -Path $using:sourcePath -Destination $using:targetPath -Recurse -Force
                  } | Wait-Job
              } else {
                  Write-Host "Copying files sequentially from $sourcePath to $targetPath"
                  Copy-Item -Path $sourcePath -Destination $targetPath -Recurse -Force
              }

              # Clean target if requested
              if ($cleanTarget) {
                  Write-Host "Cleaning target path: $targetPath"
                  Remove-Item -Path $targetPath -Recurse -Force
              }
          } catch {
              Write-Error "An error occurred: $_"
              exit 1
          }
